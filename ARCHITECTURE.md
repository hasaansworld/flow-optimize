# Architecture Overview: n8n-Integrated Multi-Agent System

## ğŸ—ï¸ Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     External Systems                            â”‚
â”‚  â€¢ Electricity Price API                                        â”‚
â”‚  â€¢ OPC UA Server (Simulation/Real)                             â”‚
â”‚  â€¢ Operator Interface                                           â”‚
â”‚  â€¢ Weather Forecast API                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Webhooks / HTTP
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     n8n Workflow Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Schedule   â”‚  â”‚  Webhook   â”‚  â”‚  Manual    â”‚               â”‚
â”‚  â”‚  Trigger   â”‚  â”‚  Trigger   â”‚  â”‚  Trigger   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚        â”‚                â”‚                â”‚                      â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                         â”‚                                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚        â†“                                  â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Get Stateâ”‚                      â”‚ Process  â”‚                â”‚
â”‚  â”‚ (HTTP)   â”‚                      â”‚ Webhook  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚
â”‚        â”‚                                  â”‚                     â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                         â†“                                       â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚  Synthesize â”‚                                â”‚
â”‚                  â”‚  (HTTP POST)â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                         â”‚                                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚        â†“                â†“                â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚Check Alertâ”‚   â”‚  Log DB  â”‚    â”‚ External â”‚                â”‚
â”‚  â”‚(IF Node)  â”‚   â”‚ (Postgres)â”‚   â”‚Notif.    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                 â”‚
â”‚  Port 5678 | Web UI: Visual workflow editor                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ HTTP API Calls
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPI Server (Port 8000)                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              REST API Endpoints                        â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  /api/v1/synthesize  â† Main decision endpoint         â”‚    â”‚
â”‚  â”‚  /api/v1/assess/*    â† Individual agents              â”‚    â”‚
â”‚  â”‚  /api/v1/state       â† System state                   â”‚    â”‚
â”‚  â”‚  /api/v1/metrics     â† Performance metrics            â”‚    â”‚
â”‚  â”‚  /webhooks/*         â† Event receivers                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                                    â”‚
â”‚                            â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          Application Logic Layer                       â”‚    â”‚
â”‚  â”‚  â€¢ Request validation (Pydantic)                      â”‚    â”‚
â”‚  â”‚  â€¢ State management                                    â”‚    â”‚
â”‚  â”‚  â€¢ Background task queuing                            â”‚    â”‚
â”‚  â”‚  â€¢ Response formatting                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                                    â”‚
â”‚                            â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           Agent Orchestration                          â”‚    â”‚
â”‚  â”‚  â€¢ Load historical data                               â”‚    â”‚
â”‚  â”‚  â€¢ Create system state                                â”‚    â”‚
â”‚  â”‚  â€¢ Call specialist agents                             â”‚    â”‚
â”‚  â”‚  â€¢ Call coordinator                                   â”‚    â”‚
â”‚  â”‚  â€¢ Format pump commands                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Python Function Calls
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Multi-Agent AI System (Python)                     â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           6 Specialist Agents (Parallel)                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚ Inflow Forecast  â”‚  â”‚  Energy Cost     â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ LSTM Model     â”‚  â”‚  â€¢ Price Pattern â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Storm Detect   â”‚  â”‚  â€¢ Arbitrage     â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚ Pump Efficiency  â”‚  â”‚  Water Safety    â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Combo Search   â”‚  â”‚  â€¢ Level Monitor â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Affinity Laws  â”‚  â”‚  â€¢ VETO Power    â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚ Flow Smoothness  â”‚  â”‚  Compliance      â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Variability    â”‚  â”‚  â€¢ Constraints   â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ WWTP Impact    â”‚  â”‚  â€¢ VETO Power    â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                Coordinator Agent                         â”‚  â”‚
â”‚  â”‚  â€¢ Collects all recommendations                         â”‚  â”‚
â”‚  â”‚  â€¢ Applies priority hierarchy                           â”‚  â”‚
â”‚  â”‚  â€¢ Gemini 2.5 Flash LLM reasoning                       â”‚  â”‚
â”‚  â”‚  â€¢ Synthesizes final pump commands                      â”‚  â”‚
â”‚  â”‚  â€¢ Safety > Compliance > Cost > Efficiency              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Supporting Components                       â”‚  â”‚
â”‚  â”‚  â€¢ LSTM Inflow Forecaster (PyTorch)                     â”‚  â”‚
â”‚  â”‚  â€¢ Pump Models (Affinity Laws)                          â”‚  â”‚
â”‚  â”‚  â€¢ Physics Simulator                                     â”‚  â”‚
â”‚  â”‚  â€¢ Price Manager                                         â”‚  â”‚
â”‚  â”‚  â€¢ Data Loader (HSY historical data)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Decision Output
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Persistence Layer                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   PostgreSQL    â”‚  â”‚     Redis       â”‚  â”‚   File System  â”‚ â”‚
â”‚  â”‚  (Port 5432)    â”‚  â”‚  (Port 6379)    â”‚  â”‚   (Volumes)    â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                â”‚ â”‚
â”‚  â”‚ â€¢ decisions     â”‚  â”‚ â€¢ State cache   â”‚  â”‚ â€¢ LSTM model   â”‚ â”‚
â”‚  â”‚ â€¢ agent_recs    â”‚  â”‚ â€¢ Session data  â”‚  â”‚ â€¢ HSY data     â”‚ â”‚
â”‚  â”‚ â€¢ state_history â”‚  â”‚ â€¢ Task queue    â”‚  â”‚ â€¢ Logs         â”‚ â”‚
â”‚  â”‚ â€¢ webhooks      â”‚  â”‚                 â”‚  â”‚                â”‚ â”‚
â”‚  â”‚ â€¢ metrics       â”‚  â”‚                 â”‚  â”‚                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Data Queries
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Monitoring & Visualization                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  Grafana (Port 3000)                      â”‚ â”‚
â”‚  â”‚  â€¢ Decision count charts                                 â”‚ â”‚
â”‚  â”‚  â€¢ Water level trends                                    â”‚ â”‚
â”‚  â”‚  â€¢ Energy cost graphs                                    â”‚ â”‚
â”‚  â”‚  â€¢ Agent confidence metrics                              â”‚ â”‚
â”‚  â”‚  â€¢ Real-time alerts                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Data Flow

### Request Flow (Scheduled)

```
1. n8n Cron Trigger (every 15 min)
   â†“
2. GET /api/v1/state/current
   â†“
3. FastAPI fetches historical data (index 500)
   â†“
4. Returns: {timestamp, L1, V, F1, F2, price, ...}
   â†“
5. n8n â†’ POST /api/v1/synthesize with state
   â†“
6. FastAPI creates SystemState object
   â†“
7. Parallel execution:
   - Inflow Agent â†’ LSTM forecast
   - Cost Agent â†’ Price pattern analysis
   - Efficiency Agent â†’ Pump combination search
   - Safety Agent â†’ Level trajectory
   - Smoothness Agent â†’ Variability check
   - Compliance Agent â†’ Constraint validation
   â†“
8. Coordinator Agent:
   - Receives all 6 recommendations
   - Gemini LLM synthesis with priority hierarchy
   - Outputs: pump commands + reasoning
   â†“
9. FastAPI formats response:
   {
     pump_commands: [...],
     coordinator_reasoning: "...",
     estimated_flow: 8000,
     estimated_cost: 25.0,
     priority: "MEDIUM",
     confidence: 0.85
   }
   â†“
10. n8n receives response
    â†“
11. IF priority == "CRITICAL":
    - Send Slack alert
    â†“
12. INSERT INTO decisions (...)
    â†“
13. Return formatted response
```

### Webhook Flow (Event-Driven)

```
1. External system â†’ POST /webhooks/price_alert
   {new_price: 0.08, old_price: 0.05, change_percent: 60}
   â†“
2. FastAPI webhook handler validates payload
   â†“
3. Check if significant (>20% change)
   â†“
4. Queue background task: trigger_cost_optimization()
   â†“
5. Return immediate acknowledgment
   â†“
6. Background task executes:
   - Create new SystemState
   - Call Cost Agent
   - If savings potential > threshold:
     â†’ Call Coordinator
     â†’ Execute pump commands
   â†“
7. Log to database
   â†“
8. Optional: Trigger n8n workflow via webhook
```

## ğŸ”„ Agent Interaction Pattern

```
SystemState
     â”‚
     â”œâ”€â†’ Inflow Agent
     â”‚    â””â”€â†’ {forecast, storm_detected, peak_inflow}
     â”‚
     â”œâ”€â†’ Cost Agent
     â”‚    â””â”€â†’ {recommendation: DEFER, arbitrage_value}
     â”‚
     â”œâ”€â†’ Efficiency Agent
     â”‚    â””â”€â†’ {recommended_pumps: [P1L, P2L], efficiency: 0.87}
     â”‚
     â”œâ”€â†’ Safety Agent (VETO power)
     â”‚    â””â”€â†’ {status: WARNING, required_action: INCREASE}
     â”‚
     â”œâ”€â†’ Smoothness Agent
     â”‚    â””â”€â†’ {allow_immediate_change: True}
     â”‚
     â”œâ”€â†’ Compliance Agent (VETO power)
     â”‚    â””â”€â†’ {compliance_status: OK, veto_required: False}
     â”‚
     â””â”€â†’ All recommendations
          â†“
     Coordinator Agent (Gemini LLM)
          â†“
     Priority Hierarchy:
     1. Safety VETO â†’ Emergency pumping
     2. Compliance VETO â†’ Block violation
     3. Cost + Efficiency â†’ Optimize
     4. Smoothness â†’ Gradual transitions
          â†“
     Final Pump Commands:
     [
       {pump_id: "P1L", start: true, frequency: 50.0},
       {pump_id: "P2L", start: true, frequency: 49.0},
       ...
     ]
```

## ğŸ³ Docker Container Communication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     n8n     â”‚â”€â”€â”€â”€â”€â–¶â”‚  agent-api  â”‚â”€â”€â”€â”€â”€â–¶â”‚  postgres   â”‚
â”‚  :5678      â”‚      â”‚   :8000     â”‚      â”‚   :5432     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚              â”‚    redis    â”‚
                            â”‚              â”‚   :6379     â”‚
                            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚   grafana   â”‚
                                           â”‚   :3000     â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

All connected via: wastewater-network (Docker bridge)
```

## ğŸ” Security Layers

```
Internet
    â†“
[Firewall / Reverse Proxy (nginx)]
    â†“
Docker Host
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   wastewater-network        â”‚
â”‚   (Internal Docker Network) â”‚
â”‚                             â”‚
â”‚   Services communicate via  â”‚
â”‚   container names:          â”‚
â”‚   - agent-api:8000         â”‚
â”‚   - postgres:5432          â”‚
â”‚   - redis:6379             â”‚
â”‚   - n8n:5678               â”‚
â”‚   - grafana:3000           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[Volume Mounts - Persistent Storage]
```

## ğŸ“ˆ Scalability Options

### Horizontal Scaling

```
Load Balancer
      â†“
â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           â”‚         â”‚         â”‚
agent-api-1 agent-api-2 ... agent-api-N
      â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
         Shared Redis
         Shared PostgreSQL
```

### Vertical Scaling

```
Resources per container:
- agent-api: 2 CPU, 4GB RAM
- n8n: 1 CPU, 2GB RAM
- postgres: 2 CPU, 4GB RAM
- redis: 0.5 CPU, 1GB RAM
- grafana: 0.5 CPU, 1GB RAM
```

## ğŸ¯ Extension Points

### 1. Add New Agent Type

```python
# src/agents/new_agent.py
class NewAgent(BaseAgent):
    def assess(self, state):
        # Custom logic
        return recommendation

# src/api/agent_api.py
@app.post("/api/v1/assess/new_agent")
async def assess_new_agent(state):
    agent = app_state.specialist_agents['new_agent']
    return agent.assess(state)
```

### 2. Add New Workflow

```json
{
  "name": "Custom Workflow",
  "nodes": [
    {"type": "trigger", ...},
    {"type": "httpRequest", "url": "http://agent-api:8000/api/v1/assess/new_agent"},
    {"type": "function", "code": "..."},
    {"type": "database", ...}
  ]
}
```

### 3. Add New Integration

n8n has 500+ built-in integrations:
- Slack, Teams, Discord
- Email (SMTP, Gmail, Outlook)
- Databases (MySQL, MongoDB, etc.)
- Cloud storage (S3, Dropbox, etc.)
- Monitoring (Datadog, Prometheus)

---

**Complete architecture supporting:**
- âœ… 7 autonomous AI agents
- âœ… Visual workflow orchestration
- âœ… Event-driven triggers
- âœ… Real-time monitoring
- âœ… Persistent storage
- âœ… Horizontal scaling
- âœ… Production deployment

